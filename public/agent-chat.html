<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Agent Marketplace - 33 Agents with Chat Controls</title>
  <style>
    :root {
      --bg: #fbfbfd;
      --bg-secondary: #f5f5f7;
      --bg-card: #ffffff;
      --bg-input: #f5f5f7;
      --bg-hover: #e8e8ed;
      --border: #d2d2d7;
      --border-light: #e5e5ea;
      --text: #1d1d1f;
      --text-secondary: #86868b;
      --text-tertiary: #6e6e73;
      --accent: #0071e3;
      --accent-hover: #0077ed;
      --success: #34c759;
      --error: #ff3b30;
      --warning: #ff9500;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', sans-serif;
      background: var(--bg);
      color: var(--text);
      height: 100vh;
      display: flex;
      overflow: hidden;
    }

    /* Sidebar */
    .sidebar {
      width: 280px;
      background: var(--bg-card);
      border-right: 1px solid var(--border-light);
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
    }
    .sidebar-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border-light);
    }
    .sidebar-header h1 {
      font-size: 17px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    .sidebar-header p {
      font-size: 12px;
      color: var(--text-secondary);
    }
    .agent-search {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border-light);
    }
    .agent-search input {
      width: 100%;
      padding: 8px 12px;
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 13px;
      color: var(--text);
    }
    .agent-search input:focus {
      outline: none;
      border-color: var(--accent);
    }
    .category-tabs {
      display: flex;
      gap: 4px;
      padding: 12px 16px;
      overflow-x: auto;
      border-bottom: 1px solid var(--border-light);
      flex-wrap: wrap;
    }
    .category-tab {
      padding: 6px 12px;
      background: transparent;
      border: none;
      border-radius: 980px;
      font-size: 11px;
      font-weight: 500;
      color: var(--text-secondary);
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.2s;
    }
    .category-tab:hover { background: var(--bg-hover); }
    .category-tab.active {
      background: var(--text);
      color: white;
    }
    .agent-list {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
    }
    .agent-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .agent-item:hover { background: var(--bg-hover); }
    .agent-item.active {
      background: rgba(0, 113, 227, 0.1);
    }
    .agent-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      background: var(--bg-secondary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      flex-shrink: 0;
    }
    .agent-item-info h3 {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 2px;
    }
    .agent-item-info p {
      font-size: 11px;
      color: var(--text-secondary);
      display: -webkit-box;
      -webkit-line-clamp: 1;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    /* Main Content Area */
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-width: 0;
      overflow: hidden;
    }
    .content-header {
      padding: 16px 24px;
      background: rgba(251, 251, 253, 0.9);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--border-light);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .content-header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .content-header-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      background: var(--bg-secondary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }
    .content-header-info h2 {
      font-size: 19px;
      font-weight: 600;
    }
    .content-header-info p {
      font-size: 13px;
      color: var(--text-secondary);
    }
    .header-btn {
      padding: 8px 16px;
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 980px;
      font-size: 13px;
      font-weight: 500;
      color: var(--text);
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .header-btn:hover { background: var(--bg-hover); }

    /* Scrollable Form Area */
    .form-scroll-area {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
    }

    /* Agent Form Card */
    .agent-form-card {
      max-width: 600px;
      margin: 0 auto;
      background: var(--bg-card);
      border-radius: 18px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
      overflow: hidden;
    }
    .form-section {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border-light);
    }
    .form-section:last-child { border-bottom: none; }
    .form-section-title {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-tertiary);
      margin-bottom: 12px;
    }
    .form-group {
      margin-bottom: 16px;
    }
    .form-group:last-child { margin-bottom: 0; }
    .form-group label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 8px;
    }
    .form-group .hint {
      font-size: 12px;
      color: var(--text-secondary);
      margin-top: 4px;
    }

    /* Inputs */
    input[type="text"],
    input[type="url"],
    input[type="number"],
    textarea,
    select {
      width: 100%;
      padding: 12px 14px;
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 10px;
      color: var(--text);
      font-size: 15px;
      font-family: inherit;
      transition: all 0.2s ease;
    }
    input::placeholder, textarea::placeholder {
      color: var(--text-tertiary);
    }
    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 4px rgba(0, 113, 227, 0.12);
    }
    textarea { min-height: 100px; resize: vertical; }
    select {
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2386868b' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      padding-right: 36px;
    }

    /* Upload Zone */
    .upload-zone {
      border: 2px dashed var(--border);
      border-radius: 12px;
      padding: 32px 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
      background: var(--bg-secondary);
    }
    .upload-zone:hover {
      border-color: var(--accent);
      background: rgba(0, 113, 227, 0.04);
    }
    .upload-zone.has-file {
      border-style: solid;
      border-color: var(--success);
      background: rgba(52, 199, 89, 0.06);
    }
    .upload-zone.dragover {
      border-color: var(--accent);
      background: rgba(0, 113, 227, 0.08);
    }
    .upload-zone input[type="file"] {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      opacity: 0;
      cursor: pointer;
    }
    .upload-icon {
      font-size: 32px;
      margin-bottom: 8px;
    }
    .upload-text {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 4px;
    }
    .upload-hint {
      font-size: 12px;
      color: var(--text-tertiary);
    }
    .upload-preview {
      max-height: 120px;
      border-radius: 8px;
      margin-top: 12px;
    }
    .upload-filename {
      font-size: 13px;
      color: var(--success);
      margin-top: 8px;
      font-weight: 500;
    }

    /* Two Column Upload */
    .two-col-uploads {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    /* Run Button */
    .run-section {
      padding: 20px 24px;
      background: var(--bg-secondary);
    }
    .run-btn {
      width: 100%;
      padding: 14px 24px;
      background: var(--accent);
      border: none;
      border-radius: 980px;
      color: white;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .run-btn:hover { background: var(--accent-hover); }
    .run-btn:active { transform: scale(0.98); }
    .run-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .run-btn.loading {
      background: var(--warning);
    }

    /* Result Section */
    .result-section {
      display: none;
      padding: 20px 24px;
      border-top: 1px solid var(--border-light);
    }
    .result-section.show { display: block; }
    .result-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    .result-status {
      font-size: 14px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .result-status.processing { color: var(--warning); }
    .result-status.completed { color: var(--success); }
    .result-status.failed { color: var(--error); }
    .progress-bar {
      height: 4px;
      background: var(--border);
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 16px;
    }
    .progress-fill {
      height: 100%;
      background: var(--accent);
      width: 0%;
      transition: width 0.3s ease;
    }
    .result-media img,
    .result-media video,
    .result-media audio {
      max-width: 100%;
      border-radius: 12px;
      margin-bottom: 12px;
    }
    .result-json {
      background: var(--bg-input);
      padding: 14px;
      border-radius: 10px;
      font-family: 'SF Mono', 'Monaco', monospace;
      font-size: 12px;
      max-height: 200px;
      overflow: auto;
      white-space: pre-wrap;
      word-break: break-all;
      color: var(--text-secondary);
    }
    .download-btn {
      padding: 10px 20px;
      background: var(--success);
      border: none;
      border-radius: 980px;
      color: white;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
    }

    /* Controls Drawer */
    .controls-drawer {
      position: fixed;
      top: 0;
      right: -380px;
      width: 380px;
      height: 100%;
      background: var(--bg-card);
      border-left: 1px solid var(--border-light);
      transition: right 0.3s cubic-bezier(0.25, 0.1, 0.25, 1);
      z-index: 1000;
      display: flex;
      flex-direction: column;
    }
    .controls-drawer.open { right: 0; }
    .drawer-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border-light);
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }
    .drawer-header h2 {
      font-size: 17px;
      font-weight: 600;
    }
    .drawer-header p {
      font-size: 12px;
      color: var(--text-secondary);
      margin-top: 4px;
    }
    .drawer-close {
      width: 28px;
      height: 28px;
      border: none;
      background: var(--bg-input);
      border-radius: 50%;
      cursor: pointer;
      font-size: 16px;
      color: var(--text-secondary);
    }
    .controls-list {
      flex: 1;
      overflow-y: auto;
      padding: 8px 24px;
    }
    .control-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 0;
      border-bottom: 1px solid var(--border-light);
    }
    .control-row:last-child { border-bottom: none; }
    .control-info h4 {
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 4px;
    }
    .control-info p {
      font-size: 12px;
      color: var(--text-secondary);
      line-height: 1.4;
    }
    .toggle {
      position: relative;
      width: 48px;
      height: 28px;
      flex-shrink: 0;
    }
    .toggle input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--border);
      border-radius: 28px;
      transition: all 0.3s;
    }
    .toggle-slider:before {
      content: '';
      position: absolute;
      width: 24px;
      height: 24px;
      left: 2px;
      bottom: 2px;
      background: white;
      border-radius: 50%;
      transition: all 0.3s;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    .toggle input:checked + .toggle-slider {
      background: var(--success);
    }
    .toggle input:checked + .toggle-slider:before {
      transform: translateX(20px);
    }
    .drawer-footer {
      padding: 16px 24px;
      border-top: 1px solid var(--border-light);
      background: var(--bg-secondary);
    }
    .drawer-footer p {
      font-size: 12px;
      color: var(--text-tertiary);
    }

    /* Overlay */
    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.3);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
      z-index: 999;
    }
    .overlay.visible {
      opacity: 1;
      pointer-events: auto;
    }

    /* Welcome Screen */
    .welcome-screen {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px;
      text-align: center;
    }
    .welcome-icon { font-size: 72px; margin-bottom: 24px; }
    .welcome-screen h2 {
      font-size: 28px;
      font-weight: 600;
      margin-bottom: 12px;
    }
    .welcome-screen p {
      font-size: 15px;
      color: var(--text-secondary);
      max-width: 460px;
      margin-bottom: 36px;
      line-height: 1.5;
    }
    .quick-actions {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      max-width: 500px;
    }
    .quick-action {
      padding: 16px 20px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 14px;
      cursor: pointer;
      transition: all 0.2s;
      text-align: left;
    }
    .quick-action:hover {
      border-color: var(--accent);
      box-shadow: 0 4px 16px rgba(0,0,0,0.08);
    }
    .quick-action-icon {
      font-size: 24px;
      margin-bottom: 8px;
    }
    .quick-action h4 {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    .quick-action p {
      font-size: 12px;
      color: var(--text-secondary);
      margin: 0;
    }

    /* Capability badges */
    .capability-badges {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-top: 12px;
    }
    .cap-badge {
      padding: 4px 10px;
      background: rgba(0, 113, 227, 0.1);
      border-radius: 6px;
      font-size: 11px;
      font-weight: 500;
      color: var(--accent);
    }
    .cap-badge.disabled {
      background: var(--bg-input);
      color: var(--text-tertiary);
      text-decoration: line-through;
    }

    @media (max-width: 900px) {
      .sidebar { width: 240px; }
      .two-col-uploads { grid-template-columns: 1fr; }
    }
    @media (max-width: 768px) {
      .sidebar { display: none; }
      .controls-drawer { width: 100%; right: -100%; }
      .quick-actions { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <h1>AI Agents</h1>
      <p>33 agents with chat controls</p>
    </div>
    <div class="agent-search">
      <input type="text" id="agentSearch" placeholder="Search agents..." oninput="filterAgents()">
    </div>
    <div class="category-tabs" id="categoryTabs"></div>
    <div class="agent-list" id="agentList"></div>
  </aside>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Header (hidden until agent selected) -->
    <div class="content-header" id="contentHeader" style="display: none;">
      <div class="content-header-left">
        <div class="content-header-icon" id="headerIcon">ü§ñ</div>
        <div class="content-header-info">
          <h2 id="headerTitle">Select an Agent</h2>
          <p id="headerDescription">Choose an agent from the sidebar</p>
        </div>
      </div>
      <button class="header-btn" onclick="toggleControls()">
        <span>‚öôÔ∏è</span> Chat Controls
      </button>
    </div>

    <!-- Welcome Screen -->
    <div class="welcome-screen" id="welcomeScreen">
      <div class="welcome-icon">ü§ñ</div>
      <h2>AI Agent Marketplace</h2>
      <p>Select an agent from the sidebar to get started. Each agent has specific inputs and capabilities that you can control.</p>
      <div class="quick-actions" id="quickActions"></div>
    </div>

    <!-- Agent Form Area -->
    <div class="form-scroll-area" id="formArea" style="display: none;">
      <div class="agent-form-card" id="agentFormCard"></div>
    </div>
  </main>

  <!-- Chat Controls Drawer -->
  <div class="controls-drawer" id="controlsDrawer">
    <div class="drawer-header">
      <div>
        <h2>Chat Controls</h2>
        <p>Toggle agent capabilities</p>
      </div>
      <button class="drawer-close" onclick="toggleControls()">√ó</button>
    </div>
    <div class="controls-list" id="controlsList"></div>
    <div class="drawer-footer">
      <p>Disabled capabilities will not be used when processing your request.</p>
    </div>
  </div>

  <!-- Overlay -->
  <div class="overlay" id="overlay" onclick="toggleControls()"></div>

  <script>
    const BASE_URL = window.location.origin;

    // Capabilities (from AgentwithChatControls)
    const CAPABILITIES = {
      image_processing: { name: 'Image Processing', description: 'Process and transform images using AI models (Replicate)' },
      image_generation: { name: 'Image Generation', description: 'Generate images from text prompts using SDXL' },
      video_processing: { name: 'Video Processing', description: 'Process and generate videos using Stable Video Diffusion' },
      audio_processing: { name: 'Audio Processing', description: 'Generate music and speech using MusicGen/Bark' },
      text_generation: { name: 'Text Generation', description: 'Generate and analyze text using GPT-4' },
      web_search: { name: 'Web Search', description: 'Search the web for current information' },
      data_analysis: { name: 'Data Analysis', description: 'Analyze data and generate insights' },
      file_upload: { name: 'File Upload', description: 'Upload and process files' },
      task_progress: { name: 'Task Progress', description: 'Show progress tracking for multi-step tasks' },
    };

    // Agent definitions with form configurations
    const AGENTS = {
      // IMAGE PROCESSING
      'background-remover': {
        name: 'Background Remover',
        icon: 'üñºÔ∏è',
        category: 'image',
        description: 'Remove backgrounds from images instantly using rembg',
        capabilities: ['image_processing', 'file_upload'],
        inputs: [
          { name: 'image', label: 'Image', type: 'image', required: true, hint: 'Upload an image or paste a URL' }
        ]
      },
      'background-replacer': {
        name: 'Background Replacer',
        icon: 'üåÑ',
        category: 'image',
        description: 'Replace backgrounds with AI-generated scenes',
        capabilities: ['image_processing', 'image_generation', 'file_upload'],
        inputs: [
          { name: 'image', label: 'Image', type: 'image', required: true },
          { name: 'newBackground', label: 'New Background Description', type: 'text', placeholder: 'e.g., tropical beach sunset, professional office' }
        ]
      },
      'image-upscaler': {
        name: 'Image Upscaler',
        icon: 'üîç',
        category: 'image',
        description: 'Upscale images up to 4x with Real-ESRGAN',
        capabilities: ['image_processing', 'file_upload'],
        inputs: [
          { name: 'image', label: 'Image', type: 'image', required: true },
          { name: 'scale', label: 'Scale Factor', type: 'select', options: ['2', '4'], default: '4' },
          { name: 'faceEnhance', label: 'Face Enhancement', type: 'select', options: ['true', 'false'], default: 'true' }
        ]
      },
      'portrait-enhancer': {
        name: 'Portrait Enhancer',
        icon: 'üë§',
        category: 'image',
        description: 'Enhance and restore portrait photos with GFPGAN',
        capabilities: ['image_processing', 'file_upload'],
        inputs: [
          { name: 'image', label: 'Portrait Image', type: 'image', required: true, hint: 'Best results with face clearly visible' }
        ]
      },
      'face-swap': {
        name: 'Face Swap',
        icon: 'üé≠',
        category: 'image',
        description: 'Swap faces between two images seamlessly',
        capabilities: ['image_processing', 'file_upload'],
        inputs: [
          { name: 'sourceImage', label: 'Source Face', type: 'image', required: true, hint: 'The face to use' },
          { name: 'targetImage', label: 'Target Image', type: 'image', required: true, hint: 'The image to swap the face into' }
        ],
        twoColumn: true
      },
      'virtual-try-on': {
        name: 'Virtual Try-On',
        icon: 'üëî',
        category: 'ecommerce',
        description: 'Try on clothes virtually using IDM-VTON',
        capabilities: ['image_processing', 'file_upload', 'task_progress'],
        inputs: [
          { name: 'personImage', label: 'Person Image', type: 'image', required: true, hint: 'Full body photo of person' },
          { name: 'garmentImage', label: 'Garment Image', type: 'image', required: true, hint: 'Clothing item to try on' },
          { name: 'category', label: 'Clothing Type', type: 'select', options: ['upper_body', 'lower_body', 'dresses'], default: 'upper_body' }
        ],
        twoColumn: true
      },
      'style-transfer': {
        name: 'Style Transfer',
        icon: 'üé®',
        category: 'creative',
        description: 'Apply artistic styles to images',
        capabilities: ['image_processing', 'image_generation', 'file_upload'],
        inputs: [
          { name: 'image', label: 'Image', type: 'image', required: true },
          { name: 'style', label: 'Style', type: 'text', placeholder: 'e.g., oil painting, watercolor, anime, Van Gogh' }
        ]
      },
      'sketch-to-image': {
        name: 'Sketch to Image',
        icon: '‚úèÔ∏è',
        category: 'creative',
        description: 'Convert sketches to realistic images with ControlNet',
        capabilities: ['image_processing', 'image_generation', 'file_upload'],
        inputs: [
          { name: 'sketch', label: 'Sketch', type: 'image', required: true },
          { name: 'prompt', label: 'Description', type: 'textarea', placeholder: 'Describe what the sketch should become...' }
        ]
      },
      'object-remover': {
        name: 'Object Remover',
        icon: 'üóëÔ∏è',
        category: 'image',
        description: 'Remove unwanted objects from images using AI inpainting',
        capabilities: ['image_processing', 'file_upload'],
        inputs: [
          { name: 'image', label: 'Image', type: 'image', required: true },
          { name: 'mask', label: 'Mask Image', type: 'image', required: true, hint: 'White areas mark objects to remove' },
          { name: 'fillPrompt', label: 'Fill With (optional)', type: 'text', placeholder: 'e.g., clean background, grass, sky' }
        ],
        twoColumn: true
      },
      'image-generator': {
        name: 'Image Generator',
        icon: 'üåü',
        category: 'creative',
        description: 'Generate images from text with SDXL',
        capabilities: ['image_generation', 'task_progress'],
        inputs: [
          { name: 'prompt', label: 'Prompt', type: 'textarea', required: true, placeholder: 'Describe the image you want to create...' },
          { name: 'negativePrompt', label: 'Negative Prompt', type: 'text', placeholder: 'What to avoid...' },
          { name: 'width', label: 'Width', type: 'select', options: ['512', '768', '1024'], default: '1024' },
          { name: 'height', label: 'Height', type: 'select', options: ['512', '768', '1024'], default: '1024' }
        ]
      },
      'scene-generator': {
        name: 'Scene Generator',
        icon: 'üé¨',
        category: 'creative',
        description: 'Generate cinematic scenes and environments',
        capabilities: ['image_generation', 'task_progress'],
        inputs: [
          { name: 'prompt', label: 'Scene Description', type: 'textarea', required: true, placeholder: 'Describe the scene or environment...' }
        ]
      },
      'product-photographer': {
        name: 'Product Photographer',
        icon: 'üì∏',
        category: 'ecommerce',
        description: 'Create professional product photos',
        capabilities: ['image_processing', 'image_generation', 'file_upload'],
        inputs: [
          { name: 'image', label: 'Product Image (optional)', type: 'image', hint: 'Or describe your product below' },
          { name: 'product', label: 'Product Description', type: 'text', placeholder: 'e.g., sleek wireless headphones, silver laptop' }
        ]
      },
      'character-creator': {
        name: 'Character Creator',
        icon: 'üßô',
        category: 'creative',
        description: 'Design unique character concepts',
        capabilities: ['image_generation', 'task_progress'],
        inputs: [
          { name: 'description', label: 'Character Description', type: 'textarea', required: true, placeholder: 'Describe the character in detail...' },
          { name: 'style', label: 'Art Style', type: 'text', placeholder: 'e.g., anime, realistic, cartoon, fantasy' }
        ]
      },
      'headshot-generator': {
        name: 'Headshot Generator',
        icon: 'üßë‚Äçüíº',
        category: 'image',
        description: 'Generate professional headshots',
        capabilities: ['image_processing', 'file_upload'],
        inputs: [
          { name: 'image', label: 'Portrait Image', type: 'image', required: true }
        ]
      },
      'portrait-retoucher': {
        name: 'Portrait Retoucher',
        icon: '‚ú®',
        category: 'image',
        description: 'Retouch and enhance portraits',
        capabilities: ['image_processing', 'file_upload'],
        inputs: [
          { name: 'image', label: 'Portrait Image', type: 'image', required: true }
        ]
      },
      'ai-model-swap': {
        name: 'AI Model Swap',
        icon: 'üëó',
        category: 'ecommerce',
        description: 'Swap models in fashion photos',
        capabilities: ['image_processing', 'file_upload'],
        inputs: [
          { name: 'sourceImage', label: 'Source Model', type: 'image', required: true },
          { name: 'targetImage', label: 'Target Photo', type: 'image', required: true }
        ],
        twoColumn: true
      },
      // VIDEO PROCESSING
      'video-generator': {
        name: 'Video Generator',
        icon: 'üé•',
        category: 'video',
        description: 'Generate videos from images with Stable Video Diffusion',
        capabilities: ['video_processing', 'file_upload', 'task_progress'],
        inputs: [
          { name: 'image', label: 'Source Image', type: 'image', required: true },
          { name: 'motionAmount', label: 'Motion Amount', type: 'select', options: ['64', '127', '200'], default: '127' },
          { name: 'fps', label: 'FPS', type: 'select', options: ['6', '7', '8'], default: '7' }
        ]
      },
      'image-animator': {
        name: 'Image Animator',
        icon: 'üéûÔ∏è',
        category: 'video',
        description: 'Animate still images',
        capabilities: ['video_processing', 'file_upload', 'task_progress'],
        inputs: [
          { name: 'image', label: 'Image to Animate', type: 'image', required: true }
        ]
      },
      'lip-sync': {
        name: 'Lip Sync',
        icon: 'üó£Ô∏è',
        category: 'video',
        description: 'Sync lips to audio with Wav2Lip',
        capabilities: ['video_processing', 'audio_processing', 'file_upload', 'task_progress'],
        inputs: [
          { name: 'face', label: 'Face Image/Video', type: 'image', required: true },
          { name: 'audio', label: 'Audio URL', type: 'url', required: true, placeholder: 'https://example.com/audio.mp3' }
        ]
      },
      'talking-avatar': {
        name: 'Talking Avatar',
        icon: 'üë§',
        category: 'video',
        description: 'Create talking avatar videos',
        capabilities: ['video_processing', 'audio_processing', 'file_upload', 'task_progress'],
        inputs: [
          { name: 'face', label: 'Avatar Face', type: 'image', required: true },
          { name: 'audio', label: 'Speech Audio URL', type: 'url', required: true }
        ]
      },
      'face-swap-video': {
        name: 'Face Swap Video',
        icon: 'üé¨',
        category: 'video',
        description: 'Swap faces in videos',
        capabilities: ['video_processing', 'file_upload', 'task_progress'],
        inputs: [
          { name: 'sourceImage', label: 'Source Face', type: 'image', required: true },
          { name: 'targetImage', label: 'Target Video/Image', type: 'image', required: true }
        ],
        twoColumn: true
      },
      // AUDIO
      'music-generator': {
        name: 'Music Generator',
        icon: 'üéµ',
        category: 'audio',
        description: 'Generate music from text with MusicGen',
        capabilities: ['audio_processing', 'task_progress'],
        inputs: [
          { name: 'prompt', label: 'Music Description', type: 'textarea', required: true, placeholder: 'e.g., upbeat electronic dance music with heavy bass' },
          { name: 'duration', label: 'Duration (seconds)', type: 'select', options: ['5', '8', '10', '15', '20'], default: '8' }
        ]
      },
      'voice-cloner': {
        name: 'Voice Cloner',
        icon: 'üéôÔ∏è',
        category: 'audio',
        description: 'Convert text to speech with Bark',
        capabilities: ['audio_processing', 'text_generation'],
        inputs: [
          { name: 'text', label: 'Text to Speak', type: 'textarea', required: true, placeholder: 'Enter the text to convert to speech...' },
          { name: 'voicePreset', label: 'Voice', type: 'select', options: ['en_speaker_0', 'en_speaker_1', 'en_speaker_6', 'en_speaker_9', 'announcer'], default: 'en_speaker_6' }
        ]
      },
      // TEXT/ANALYTICS
      'smart-data-analyzer': {
        name: 'Data Analyzer',
        icon: 'üìä',
        category: 'analytics',
        description: 'Analyze data and provide insights',
        capabilities: ['data_analysis', 'text_generation'],
        inputs: [
          { name: 'data', label: 'Data', type: 'textarea', required: true, placeholder: 'Paste your data here (JSON, CSV, or plain text)...' }
        ]
      },
      'product-description-writer': {
        name: 'Product Writer',
        icon: '‚úçÔ∏è',
        category: 'marketing',
        description: 'Write compelling product descriptions',
        capabilities: ['text_generation'],
        inputs: [
          { name: 'product', label: 'Product Name', type: 'text', required: true },
          { name: 'features', label: 'Features', type: 'textarea', placeholder: 'List key features...' },
          { name: 'audience', label: 'Target Audience', type: 'text', placeholder: 'Who is this for?' }
        ]
      },
      'email-template-generator': {
        name: 'Email Generator',
        icon: 'üìß',
        category: 'marketing',
        description: 'Create professional email templates',
        capabilities: ['text_generation'],
        inputs: [
          { name: 'purpose', label: 'Email Purpose', type: 'text', required: true, placeholder: 'e.g., product launch, newsletter, follow-up' },
          { name: 'tone', label: 'Tone', type: 'select', options: ['professional', 'friendly', 'urgent', 'casual'], default: 'professional' },
          { name: 'details', label: 'Key Details', type: 'textarea', placeholder: 'What should the email include?' }
        ]
      },
      'seo-content-optimizer': {
        name: 'SEO Optimizer',
        icon: 'üîé',
        category: 'marketing',
        description: 'Optimize content for search engines',
        capabilities: ['text_generation', 'web_search'],
        inputs: [
          { name: 'content', label: 'Content', type: 'textarea', required: true, placeholder: 'Paste your content to optimize...' },
          { name: 'keywords', label: 'Target Keywords', type: 'text', placeholder: 'Comma-separated keywords' }
        ]
      },
      'social-media-caption-generator': {
        name: 'Caption Generator',
        icon: 'üí¨',
        category: 'marketing',
        description: 'Generate social media captions',
        capabilities: ['text_generation'],
        inputs: [
          { name: 'topic', label: 'Topic/Product', type: 'text', required: true },
          { name: 'platform', label: 'Platform', type: 'select', options: ['instagram', 'twitter', 'linkedin', 'all'], default: 'all' },
          { name: 'tone', label: 'Tone', type: 'select', options: ['fun', 'professional', 'inspiring', 'casual'], default: 'fun' }
        ]
      },
      'video-script-generator': {
        name: 'Script Generator',
        icon: 'üé¨',
        category: 'content',
        description: 'Write engaging video scripts',
        capabilities: ['text_generation'],
        inputs: [
          { name: 'topic', label: 'Video Topic', type: 'text', required: true },
          { name: 'duration', label: 'Target Duration', type: 'select', options: ['30 seconds', '1 minute', '2 minutes', '5 minutes'], default: '1 minute' },
          { name: 'style', label: 'Style', type: 'select', options: ['tutorial', 'promotional', 'educational', 'entertainment'], default: 'tutorial' }
        ]
      },
      'customer-support-bot': {
        name: 'Support Bot',
        icon: 'üíÅ',
        category: 'productivity',
        description: 'Generate customer support responses',
        capabilities: ['text_generation'],
        inputs: [
          { name: 'query', label: 'Customer Query', type: 'textarea', required: true, placeholder: 'Enter the customer question or issue...' },
          { name: 'context', label: 'Context', type: 'textarea', placeholder: 'Any relevant background information...' }
        ]
      },
      'resume-builder': {
        name: 'Resume Builder',
        icon: 'üìÑ',
        category: 'productivity',
        description: 'Create professional resume content',
        capabilities: ['text_generation'],
        inputs: [
          { name: 'role', label: 'Target Role', type: 'text', required: true },
          { name: 'experience', label: 'Experience', type: 'textarea', placeholder: 'Describe your relevant experience...' },
          { name: 'skills', label: 'Skills', type: 'text', placeholder: 'Comma-separated skills' }
        ]
      },
      'data-visualization': {
        name: 'Data Viz Advisor',
        icon: 'üìà',
        category: 'analytics',
        description: 'Get data visualization suggestions',
        capabilities: ['data_analysis', 'text_generation'],
        inputs: [
          { name: 'data', label: 'Data Description', type: 'textarea', required: true, placeholder: 'Describe your data structure and what you want to show...' }
        ]
      },
      'ai-assistant': {
        name: 'AI Assistant',
        icon: 'ü§ñ',
        category: 'productivity',
        description: 'General purpose AI assistant',
        capabilities: ['text_generation', 'web_search', 'data_analysis', 'task_progress'],
        inputs: [
          { name: 'prompt', label: 'Your Request', type: 'textarea', required: true, placeholder: 'Ask me anything...' }
        ]
      }
    };

    // State
    let currentAgent = null;
    let settings = {};
    let uploadedFiles = {};
    let isProcessing = false;
    let activeCategory = 'all';

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      renderCategories();
      renderAgentList();
      renderQuickActions();
    });

    function renderCategories() {
      const categories = ['all', ...new Set(Object.values(AGENTS).map(a => a.category))];
      document.getElementById('categoryTabs').innerHTML = categories.map(cat => `
        <button class="category-tab ${cat === 'all' ? 'active' : ''}" onclick="filterByCategory('${cat}')">
          ${cat.charAt(0).toUpperCase() + cat.slice(1)}
        </button>
      `).join('');
    }

    function renderAgentList(filter = '') {
      const agents = Object.entries(AGENTS).filter(([id, agent]) => {
        const matchesSearch = agent.name.toLowerCase().includes(filter.toLowerCase()) ||
                             agent.description.toLowerCase().includes(filter.toLowerCase());
        const matchesCategory = activeCategory === 'all' || agent.category === activeCategory;
        return matchesSearch && matchesCategory;
      });

      document.getElementById('agentList').innerHTML = agents.map(([id, agent]) => `
        <div class="agent-item ${currentAgent === id ? 'active' : ''}" onclick="selectAgent('${id}')">
          <div class="agent-icon">${agent.icon}</div>
          <div class="agent-item-info">
            <h3>${agent.name}</h3>
            <p>${agent.description}</p>
          </div>
        </div>
      `).join('');
    }

    function renderQuickActions() {
      const featured = ['image-generator', 'background-remover', 'face-swap', 'music-generator'];
      document.getElementById('quickActions').innerHTML = featured.map(id => {
        const agent = AGENTS[id];
        return `
          <div class="quick-action" onclick="selectAgent('${id}')">
            <div class="quick-action-icon">${agent.icon}</div>
            <h4>${agent.name}</h4>
            <p>${agent.description}</p>
          </div>
        `;
      }).join('');
    }

    function filterAgents() {
      renderAgentList(document.getElementById('agentSearch').value);
    }

    function filterByCategory(category) {
      activeCategory = category;
      document.querySelectorAll('.category-tab').forEach(tab => {
        tab.classList.toggle('active', tab.textContent.trim().toLowerCase() === category);
      });
      renderAgentList(document.getElementById('agentSearch').value);
    }

    function selectAgent(agentId) {
      currentAgent = agentId;
      const agent = AGENTS[agentId];
      uploadedFiles = {};

      // Initialize settings
      settings = {};
      agent.capabilities.forEach(cap => settings[cap] = true);

      // Update header
      document.getElementById('welcomeScreen').style.display = 'none';
      document.getElementById('contentHeader').style.display = 'flex';
      document.getElementById('formArea').style.display = 'block';
      document.getElementById('headerIcon').textContent = agent.icon;
      document.getElementById('headerTitle').textContent = agent.name;
      document.getElementById('headerDescription').textContent = agent.description;

      // Render form
      renderAgentForm(agent);
      renderControls();
      renderAgentList(document.getElementById('agentSearch').value);
    }

    function renderAgentForm(agent) {
      const hasImageInputs = agent.inputs.filter(i => i.type === 'image').length > 1 && agent.twoColumn;

      let inputsHtml = agent.inputs.map(input => {
        if (input.type === 'image') {
          return `
            <div class="form-group">
              <label>${input.label}${input.required ? ' *' : ''}</label>
              <div class="upload-zone" id="upload-${input.name}"
                   ondrop="handleDrop(event, '${input.name}')"
                   ondragover="handleDragOver(event, '${input.name}')"
                   ondragleave="handleDragLeave(event, '${input.name}')">
                <div class="upload-icon">üìÅ</div>
                <div class="upload-text">Drop image here or click to upload</div>
                <div class="upload-hint">Or paste an image URL below</div>
                <input type="file" accept="image/*" onchange="handleFileUpload(event, '${input.name}')">
              </div>
              <input type="url" id="url-${input.name}" placeholder="https://example.com/image.jpg" style="margin-top: 8px;">
              ${input.hint ? `<div class="hint">${input.hint}</div>` : ''}
            </div>
          `;
        } else if (input.type === 'select') {
          return `
            <div class="form-group">
              <label>${input.label}</label>
              <select id="input-${input.name}">
                ${input.options.map(opt => `<option value="${opt}" ${opt === input.default ? 'selected' : ''}>${opt}</option>`).join('')}
              </select>
            </div>
          `;
        } else if (input.type === 'textarea') {
          return `
            <div class="form-group">
              <label>${input.label}${input.required ? ' *' : ''}</label>
              <textarea id="input-${input.name}" placeholder="${input.placeholder || ''}"></textarea>
              ${input.hint ? `<div class="hint">${input.hint}</div>` : ''}
            </div>
          `;
        } else {
          return `
            <div class="form-group">
              <label>${input.label}${input.required ? ' *' : ''}</label>
              <input type="${input.type || 'text'}" id="input-${input.name}" placeholder="${input.placeholder || ''}">
              ${input.hint ? `<div class="hint">${input.hint}</div>` : ''}
            </div>
          `;
        }
      }).join('');

      // Wrap two-column uploads
      if (hasImageInputs) {
        const imageInputs = agent.inputs.filter(i => i.type === 'image');
        const otherInputs = agent.inputs.filter(i => i.type !== 'image');

        const imageHtml = imageInputs.map(input => `
          <div class="form-group">
            <label>${input.label}${input.required ? ' *' : ''}</label>
            <div class="upload-zone" id="upload-${input.name}"
                 ondrop="handleDrop(event, '${input.name}')"
                 ondragover="handleDragOver(event, '${input.name}')"
                 ondragleave="handleDragLeave(event, '${input.name}')">
              <div class="upload-icon">üìÅ</div>
              <div class="upload-text">Drop image here</div>
              <input type="file" accept="image/*" onchange="handleFileUpload(event, '${input.name}')">
            </div>
            <input type="url" id="url-${input.name}" placeholder="Or paste URL" style="margin-top: 8px; font-size: 12px;">
            ${input.hint ? `<div class="hint">${input.hint}</div>` : ''}
          </div>
        `).join('');

        const otherHtml = otherInputs.map(input => {
          if (input.type === 'select') {
            return `
              <div class="form-group">
                <label>${input.label}</label>
                <select id="input-${input.name}">
                  ${input.options.map(opt => `<option value="${opt}" ${opt === input.default ? 'selected' : ''}>${opt}</option>`).join('')}
                </select>
              </div>
            `;
          } else if (input.type === 'textarea') {
            return `
              <div class="form-group">
                <label>${input.label}${input.required ? ' *' : ''}</label>
                <textarea id="input-${input.name}" placeholder="${input.placeholder || ''}"></textarea>
              </div>
            `;
          } else {
            return `
              <div class="form-group">
                <label>${input.label}${input.required ? ' *' : ''}</label>
                <input type="${input.type || 'text'}" id="input-${input.name}" placeholder="${input.placeholder || ''}">
              </div>
            `;
          }
        }).join('');

        inputsHtml = `<div class="two-col-uploads">${imageHtml}</div>${otherHtml}`;
      }

      // Capability badges
      const capBadges = agent.capabilities.map(cap => {
        const capInfo = CAPABILITIES[cap];
        return `<span class="cap-badge" id="badge-${cap}">${capInfo?.name || cap}</span>`;
      }).join('');

      document.getElementById('agentFormCard').innerHTML = `
        <div class="form-section">
          <div class="form-section-title">Inputs</div>
          ${inputsHtml}
        </div>
        <div class="form-section">
          <div class="form-section-title">Active Capabilities</div>
          <div class="capability-badges">${capBadges}</div>
        </div>
        <div class="run-section">
          <button class="run-btn" id="runBtn" onclick="runAgent()">
            <span>‚ñ∂</span> Run ${agent.name}
          </button>
        </div>
        <div class="result-section" id="resultSection">
          <div class="result-header">
            <div class="result-status" id="resultStatus">Processing...</div>
            <button class="download-btn" id="downloadBtn" style="display: none;" onclick="downloadResult()">Download</button>
          </div>
          <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
          <div class="result-media" id="resultMedia"></div>
          <div class="result-json" id="resultJson"></div>
        </div>
      `;
    }

    function renderControls() {
      if (!currentAgent) return;
      const agent = AGENTS[currentAgent];

      document.getElementById('controlsList').innerHTML = agent.capabilities.map(capKey => {
        const cap = CAPABILITIES[capKey];
        if (!cap) return '';
        return `
          <div class="control-row">
            <div class="control-info">
              <h4>${cap.name}</h4>
              <p>${cap.description}</p>
            </div>
            <label class="toggle">
              <input type="checkbox" ${settings[capKey] ? 'checked' : ''} onchange="toggleCapability('${capKey}')">
              <span class="toggle-slider"></span>
            </label>
          </div>
        `;
      }).join('');
    }

    function toggleCapability(key) {
      settings[key] = !settings[key];
      const badge = document.getElementById(`badge-${key}`);
      if (badge) badge.classList.toggle('disabled', !settings[key]);
    }

    function toggleControls() {
      document.getElementById('controlsDrawer').classList.toggle('open');
      document.getElementById('overlay').classList.toggle('visible');
    }

    // File handling
    function handleFileUpload(event, inputName) {
      const file = event.target.files[0];
      if (!file) return;
      processFile(file, inputName);
    }

    function handleDrop(event, inputName) {
      event.preventDefault();
      const zone = document.getElementById(`upload-${inputName}`);
      zone.classList.remove('dragover');
      const file = event.dataTransfer.files[0];
      if (file) processFile(file, inputName);
    }

    function handleDragOver(event, inputName) {
      event.preventDefault();
      document.getElementById(`upload-${inputName}`).classList.add('dragover');
    }

    function handleDragLeave(event, inputName) {
      document.getElementById(`upload-${inputName}`).classList.remove('dragover');
    }

    function processFile(file, inputName) {
      const zone = document.getElementById(`upload-${inputName}`);
      const reader = new FileReader();
      reader.onload = (e) => {
        uploadedFiles[inputName] = e.target.result;
        zone.innerHTML = `
          <img src="${e.target.result}" class="upload-preview" alt="Preview">
          <div class="upload-filename">${file.name}</div>
          <input type="file" accept="image/*" onchange="handleFileUpload(event, '${inputName}')">
        `;
        zone.classList.add('has-file');
      };
      reader.readAsDataURL(file);
    }

    // Run agent
    async function runAgent() {
      if (!currentAgent || isProcessing) return;
      const agent = AGENTS[currentAgent];
      const input = {};

      // Collect inputs
      for (const inp of agent.inputs) {
        if (inp.type === 'image') {
          // Check uploaded file first, then URL
          if (uploadedFiles[inp.name]) {
            input[inp.name] = uploadedFiles[inp.name];
          } else {
            const urlEl = document.getElementById(`url-${inp.name}`);
            if (urlEl && urlEl.value.trim()) {
              input[inp.name] = urlEl.value.trim();
            }
          }
        } else {
          const el = document.getElementById(`input-${inp.name}`);
          if (el && el.value.trim()) {
            input[inp.name] = el.value.trim();
          }
        }
      }

      // Show result section
      const resultSection = document.getElementById('resultSection');
      const resultStatus = document.getElementById('resultStatus');
      const progressFill = document.getElementById('progressFill');
      const resultMedia = document.getElementById('resultMedia');
      const resultJson = document.getElementById('resultJson');
      const downloadBtn = document.getElementById('downloadBtn');
      const runBtn = document.getElementById('runBtn');

      resultSection.classList.add('show');
      resultStatus.className = 'result-status processing';
      resultStatus.textContent = 'Processing...';
      progressFill.style.width = '20%';
      resultMedia.innerHTML = '';
      resultJson.textContent = '';
      downloadBtn.style.display = 'none';
      runBtn.disabled = true;
      runBtn.classList.add('loading');
      runBtn.innerHTML = '<span>‚è≥</span> Processing...';
      isProcessing = true;

      try {
        const response = await fetch(`${BASE_URL}/mulerun/agents/${currentAgent}/run`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ input, settings })
        });

        const data = await response.json();

        if (data.jobId) {
          // Async job - poll for result
          await pollJob(data.jobId, progressFill, resultStatus);
        } else {
          // Sync result
          progressFill.style.width = '100%';
          displayResult(data, resultStatus, resultMedia, resultJson, downloadBtn);
        }
      } catch (error) {
        resultStatus.className = 'result-status failed';
        resultStatus.textContent = `Error: ${error.message}`;
      }

      isProcessing = false;
      runBtn.disabled = false;
      runBtn.classList.remove('loading');
      runBtn.innerHTML = `<span>‚ñ∂</span> Run ${agent.name}`;
    }

    async function pollJob(jobId, progressFill, resultStatus) {
      return new Promise((resolve) => {
        const poll = async () => {
          const res = await fetch(`${BASE_URL}/jobs/${jobId}`);
          const job = await res.json();

          progressFill.style.width = `${job.progress || 50}%`;
          resultStatus.textContent = `${job.status} - ${job.progress || 0}%`;

          if (job.status === 'completed') {
            progressFill.style.width = '100%';
            displayResult({ output: job.output },
              document.getElementById('resultStatus'),
              document.getElementById('resultMedia'),
              document.getElementById('resultJson'),
              document.getElementById('downloadBtn'));
            resolve();
          } else if (job.status === 'failed') {
            resultStatus.className = 'result-status failed';
            resultStatus.textContent = `Failed: ${job.error}`;
            resolve();
          } else {
            setTimeout(poll, 2000);
          }
        };
        poll();
      });
    }

    function displayResult(data, statusEl, mediaEl, jsonEl, downloadBtn) {
      // Check for errors first
      if (data.error || data.status === 'failed') {
        statusEl.className = 'result-status failed';
        statusEl.textContent = 'Failed';
        mediaEl.innerHTML = `<div style="color: var(--error); padding: 16px; background: rgba(255,59,48,0.1); border-radius: 10px;">
          <strong>Error:</strong> ${data.error || 'Processing failed'}
        </div>`;
        jsonEl.textContent = JSON.stringify(data, null, 2);
        return;
      }

      statusEl.className = 'result-status completed';
      statusEl.textContent = 'Completed';

      const output = data.output || data;
      let mediaHtml = '';
      let downloadUrl = null;

      // Extract and display media
      const imageUrls = extractImageUrls(output);
      const videoUrl = extractVideoUrl(output);
      const audioUrl = extractAudioUrl(output);

      if (imageUrls.length > 0) {
        mediaHtml = `<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
          ${imageUrls.map(url => `<img src="${url}" alt="Result" style="width: 100%; border-radius: 12px; cursor: pointer;" onclick="window.open('${url}', '_blank')">`).join('')}
        </div>`;
        downloadUrl = imageUrls[0];
      }

      if (videoUrl) {
        mediaHtml += `<video src="${videoUrl}" controls style="width: 100%; border-radius: 12px; margin-top: 12px;"></video>`;
        downloadUrl = downloadUrl || videoUrl;
      }

      if (audioUrl) {
        mediaHtml += `<audio src="${audioUrl}" controls style="width: 100%; margin-top: 12px;"></audio>`;
        downloadUrl = downloadUrl || audioUrl;
      }

      // Show text output for text-based agents
      if (!mediaHtml) {
        let textContent = '';
        // Check various text output fields
        if (output.response) textContent = output.response;
        else if (output.headline) textContent = `<strong>${output.headline}</strong><br><br>${output.description || ''}`;
        else if (output.caption) textContent = output.caption;
        else if (output.optimizedContent) textContent = output.optimizedContent;
        else if (output.professionalSummary) textContent = output.professionalSummary;
        else if (output.summary) textContent = output.summary;

        if (textContent) {
          mediaHtml = `<div style="padding: 16px; background: var(--bg-input); border-radius: 10px; white-space: pre-wrap;">${textContent}</div>`;
        }
      }

      if (downloadUrl) {
        downloadBtn.style.display = 'block';
        downloadBtn.onclick = () => window.open(downloadUrl, '_blank');
      }

      mediaEl.innerHTML = mediaHtml || '<div style="color: var(--text-secondary);">Processing complete. See details below.</div>';
      jsonEl.textContent = JSON.stringify(output, null, 2);
    }

    function extractImageUrls(obj) {
      const urls = [];
      // Check all possible image output fields
      if (Array.isArray(obj.images)) urls.push(...obj.images);
      if (Array.isArray(obj.output)) urls.push(...obj.output.filter(u => typeof u === 'string' && (u.startsWith('http') || u.startsWith('data:'))));
      // resultImage can be string or array (Virtual Try-On returns array)
      if (Array.isArray(obj.resultImage)) {
        urls.push(...obj.resultImage.filter(u => typeof u === 'string'));
      } else if (obj.resultImage) {
        urls.push(obj.resultImage);
      }
      if (obj.enhancedImage) urls.push(obj.enhancedImage);
      if (obj.upscaledImage) urls.push(obj.upscaledImage);
      if (obj.generatedImage) urls.push(obj.generatedImage);
      if (obj.stylizedImage) urls.push(obj.stylizedImage);
      if (obj.sceneImage) urls.push(obj.sceneImage);
      if (obj.productImage) urls.push(obj.productImage);
      if (Array.isArray(obj.characterImages)) urls.push(...obj.characterImages);
      if (obj.subjectWithTransparentBg) urls.push(obj.subjectWithTransparentBg);
      if (obj.productWithTransparentBg) urls.push(obj.productWithTransparentBg);
      if (obj.generatedBackground) urls.push(obj.generatedBackground);
      if (obj.imageUrl) urls.push(obj.imageUrl);
      // Single output field
      if (typeof obj.output === 'string' && (obj.output.startsWith('http') || obj.output.startsWith('data:'))) {
        if (!obj.output.includes('.mp4') && !obj.output.includes('.webm') && !obj.output.includes('.mp3') && !obj.output.includes('.wav')) {
          urls.push(obj.output);
        }
      }
      return urls.filter(u => u && typeof u === 'string');
    }

    function extractVideoUrl(obj) {
      return obj.video || obj.syncedVideo || obj.videoUrl ||
             (typeof obj.output === 'string' && (obj.output.includes('.mp4') || obj.output.includes('.webm')) ? obj.output : null);
    }

    function extractAudioUrl(obj) {
      return obj.audioUrl || obj.audio ||
             (typeof obj.output === 'string' && (obj.output.includes('.mp3') || obj.output.includes('.wav')) ? obj.output : null);
    }
  </script>
</body>
</html>
